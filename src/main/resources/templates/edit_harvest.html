
<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Editar Cosecha - Agrow</title>
    <link rel="stylesheet" th:href="@{/css/common.css}" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"/>
</head>
<body>

<div th:replace="~{fragments/sidebar :: sidebar}"></div>

<div class="main-content">
    <div id="swal-message" th:data-mensaje="${mensaje}" th:data-error="${error}"></div>

    <div class="page-header">
        <div>
            <h1 class="page-title">Editar Cosecha</h1>
            <p class="page-subtitle">Modifica los detalles de la cosecha seleccionada</p>
        </div>
        <a th:href="@{/harvests/list}" class="btn btn-secondary">
            <span class="material-symbols-outlined icon">arrow_back</span> Volver al Listado
        </a>
    </div>

    <!-- Mensaje de advertencia si hay ventas -->
    <div class="info-card" style="background-color: var(--warning-light-alt); border-color: var(--warning); color: var(--warning-text-alt);" th:if="${hasSales}">
        <span class="material-symbols-outlined icon" style="color: var(--warning);">warning</span>
        <h2>Cosecha con Ventas Registradas</h2>
        <p>Esta cosecha ya tiene ventas asociadas. Solo se puede modificar el total cosechado si el nuevo valor no es menor a la cantidad ya vendida (<span th:text="${harvest.quantityHarvested - harvest.availableQuantity}">0</span> kg).</p>
    </div>


    <div class="form-container">
        <form th:action="@{/harvests/update}" method="post" id="editHarvestForm" class="confirm-action" data-message="¿Confirmar los cambios en la cosecha?" data-title="Confirmar Actualización">
            <input type="hidden" id="idHarvest" name="idHarvest" th:value="${harvest != null ? harvest.idHarvest : ''}" />

            <div class="form-group">
                <label for="typeC" class="form-label">Tipo Cosecha</label>
                <input type="text" class="form-input" id="typeC" name="typeC"
                       th:value="${harvest != null ? harvest.typeHarvest : ''}"
                       maxlength="50" required>
            </div>

            <div class="form-group">
                <label for="dateC" class="form-label">Fecha de Cosecha</label>
                <!-- Usar date-picker-iso para flatpickr -->
                <input type="text" id="dateC" name="dateC" class="form-input date-picker-iso"
                       th:value="${harvest != null ? #temporals.format(harvest.dateHarvested, 'yyyy-MM-dd') : ''}" required placeholder="yyyy-mm-dd">
            </div>

            <div class="form-group">
                <label for="totalC" class="form-label">Total Cosechado (kg)</label>
                <input type="number" class="form-input" id="totalC" name="totalC" step="1" min="1"  -- Cambiado step y min a enteros
                       th:value="${harvest != null ? harvest.quantityHarvested : ''}" required
                       title="Cantidad total cosechada originalmente. Solo modificable si es mayor o igual a la cantidad ya vendida.">
                <!-- Mensaje informativo si tiene ventas -->
                <p class="form-info" th:if="${hasSales}">Cantidad ya vendida: <span th:text="${harvest.quantityHarvested - harvest.availableQuantity}"></span> kg. El nuevo total debe ser mayor o igual.</p>
            </div>

            <div class="form-group">
                <label for="availableQuantity" class="form-label">Cantidad Disponible (kg):</label>
                <input type="number" class="form-input" id="availableQuantity" name="availableQuantity"
                       th:value="${harvest != null ? harvest.availableQuantity : ''}" readonly disabled
                       title="Cantidad disponible para la venta (calculada automáticamente).">
            </div>


            <div class="form-group">
                <label for="stateC" class="form-label">Calidad</label>
                <select class="form-select" id="stateC" name="stateC" required>
                    <option value="" disabled>Seleccione</option>
                    <option value="Premium" th:selected="${harvest != null && harvest.quality == 'Premium'}">Premium</option>
                    <option value="Estándar" th:selected="${harvest != null && harvest.quality == 'Estándar'}">Estándar</option>
                    <option value="Secundaria" th:selected="${harvest != null && harvest.quality == 'Secundaria'}">Secundaria</option>
                </select>
            </div>

            <div class="form-group">
                <label for="producerId" class="form-label">Productor</label>
                <select class="form-select" id="producerId" name="id_producer" required>
                    <option value="" disabled>Seleccione un productor</option>
                    <th:block th:each="prod : ${producers}">
                        <option th:value="${prod.id_producer}"
                                th:text="${prod.producerName}"
                                th:selected="${prod.id_producer == harvest.id_producer}">
                        </option>
                    </th:block>
                </select>
            </div>

            <div class="form-group">
                <label for="destinyC" class="form-label">Destino</label>
                <input type="text" class="form-input" id="destinyC" maxlength="100" name="destinyC" th:value="${harvest != null ? harvest.destiny : ''}" required>
            </div>

            <div class="form-group">
                <label for="descriptionC" class="form-label">Descripción</label>
                <textarea class="form-input" id="descriptionC" name="descriptionC" maxlength="250" rows="4" required th:text="${harvest != null ? harvest.description : ''}"></textarea>
            </div>

            <div class="form-actions">
                <button id="confirmButton" class="btn btn-primary" type="submit">
                    <span class="material-symbols-outlined icon">save</span> Guardar Cambios
                </button>
                <a th:href="@{/harvests/list}" class="btn btn-secondary">
                    <span class="material-symbols-outlined icon">cancel</span> Cancelar
                </a>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script th:src="@{/js/app.js}"></script>
</body>
</html>